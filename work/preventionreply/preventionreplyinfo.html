<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>动物疫病防控</title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app.css" />
	</head>

	<body>
		<header id="navtitle" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title adp-title">防疫工作接收</h1>
		</header>
		<div id="preventionreplyForm" class="mui-content">
			<div id="preventionreplyBasePart" class="mui-input-group workBlock">
				<div class="mui-input-row">
					<label>防疫工作编号</label>
					<input id="preventreplyNum" type="text" value="" readonly="true">
				</div>
				<div class="mui-input-row">
					<label>防疫员姓名</label>
					<input id="workersName1" type="text" readonly="true">
				</div>
			</div>
			<div class="mui-content-padded" style="height:20px;">
				<h5 class="mui-pull-left">农户信息</h5>

			</div>
			<div id="farmerPart" class="mui-input-group workBlock">
				<ul class="mui-table-view">
					<!--<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right">董国良</a>
						<div class="mui-collapse-content">
							<div class="mui-input-row">
								<label>农户电话</label>
								<input id="farmerPhoneP1" type="text" readonly="true">
							</div>
							<div class="mui-content-padded" style="height:20px;">
								<h5 class="mui-pull-left">免疫动物</h5>
								<button type="button" class="mui-btn mui-btn-link mui-pull-right">添加</button>

							</div>
							<div id="animalAddPart5">
								<div class="mui-input-group contentB">
									<div class="mui-input-row">
										<label>动物名称</label>
										<input id="animalNameP1" type="text" placeholder="请输入动物名称">
									</div>
									<div class="mui-input-row">
										<label>数量</label>
										<input id="animalCountP1" type="text" placeholder="请输入动物数量">
									</div>
									<div class="mui-input-row">
										<button id='showUnitPickerP1' class="mui-btn mui-btn-block" type='button'>点击选择动物单位</button>
									</div>
									<span class="mui-icon mui-icon-close delIcon"></span>
								</div>
							</div>
						</div>
					</li>-->
					<!--<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right">董国良</a>
						<div class="mui-collapse-content">
							<div class="mui-input-row">
								<label>农户电话</label>
								<input id="farmerPhoneP1" type="text" readonly="true">
							</div>
							<div id="preventionreplyPart1" class="mui-content-padded" style="height:20px;">
								<h5 class="mui-pull-left">免疫动物</h5>
								<button type="button" class="mui-btn mui-btn-link mui-pull-right">添加</button>

							</div>
							<div id="animalAddPart5">
								<div class="mui-input-group contentB">
									<div class="mui-input-row">
										<label>动物名称</label>
										<input id="animalNameP1" type="text" placeholder="请输入动物名称">
									</div>
									<div class="mui-input-row">
										<label>数量</label>
										<input id="animalCountP1" type="text" placeholder="请输入动物数量">
									</div>
									<div class="mui-input-row">
										<button id='showUnitPickerP1' class="mui-btn mui-btn-block" type='button'>点击选择动物单位</button>
									</div>
									<span class="mui-icon mui-icon-close delIcon"></span>
								</div>
								<div class="mui-input-group contentB">
									<div class="mui-input-row">
										<label>动物名称</label>
										<input id="animalNameP1" type="text" placeholder="请输入动物名称">
									</div>
									<div class="mui-input-row">
										<label>数量</label>
										<input id="animalCountP1" type="text" placeholder="请输入动物数量">
									</div>
									<div class="mui-input-row">
										<button id='showUnitPickerP1' class="mui-btn mui-btn-block" type='button'>点击选择动物单位</button>
									</div>
									<span class="mui-icon mui-icon-close delIcon"></span>
								</div>
							</div>
						</div>
					</li>-->
				</ul>
			</div>
			<div id="vaccineinfoPart1" class="mui-input-group workBlock">
				<div class="mui-input-row">
					<label>疫苗名称<span class="redFont">*</span></label>
					<input id="vaccineinfoname1" type="text" placeholder="请输入疫苗名称">
				</div>
				<div class="mui-input-row">
					<label>规格<span class="redFont">*</span></label>
					<input id="guige1" type="text" placeholder="请输入规格">
				</div>
				<div class="mui-input-row">
					<label>用量<span class="redFont">*</span></label>
					<input id="yongliang1" type="text" placeholder="请输入用量">
				</div>
				<div class="mui-input-row">
					<button id='showUnitPickerQ1' class="mui-btn mui-btn-block" type='button'>点击选择用量单位</button>
				</div>
				<div class="mui-input-row">
					<label>疫苗数量<span class="redFont">*</span></label>
					<input id="yimiaoshuliang1" type="text" placeholder="请输入数量">
				</div>
				<div class="mui-input-row">
					<button id='showUnitYm1' class="mui-btn mui-btn-block" type='button'>点击选择数量单位</button>
				</div>
			</div>
			<div id="DateMangPart1" class="mui-input-group workBlock" style="padding-top:1px ;">

				<div class="mui-input-row">
					<label>领取日期</label>
					<button id='lqDate' class="btn mui-btn mui-btn-block dateTop " data-options='{"type":"date","beginYear":2014}'>请选择领取日期</button>
				</div>
				<div class="mui-input-row">
					<label>免疫日期</label>
					<button id='mianyiDate' class="btn mui-btn mui-btn-block dateTop " data-options='{"type":"date","beginYear":2014}'>请选择免疫日期</button>
				</div>
			</div>
			<div id="loadpicPart" class="mui-input-group workBlock">
				<div class="mui-input-row" style="height:auto;">
					<label>附件</label>
					<div class="mui-row">
						<span id="attachment" class="delAttachment"><i class="mui-icon mui-icon-plus"></i>点击新增附件</span>
					</div>
				</div>
			</div>
			<input type="hidden" id="lon"/><input type="hidden" id="lat"/>
			<button id='addreplySaveBtn' class="mui-btn mui-btn-block mui-btn-success">提交</button>
		</div>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/mui.picker.min.js"></script>
		<script type="text/javascript" src="../../js/app.js" ></script>
		<script type="text/javascript" src="../../js/errorcode.js" ></script>
		<script type="text/javascript" src="../../js/animalunit.data.js" ></script>
		<script type="text/javascript" src="../../js/useunit.data.js" ></script>
		<script type="text/javascript" src="../../js/vacunit.data.js" ></script>
		<script>
			var wd,workerName,workId,farmerList=[];
			var userPicker = new mui.PopPicker();
			userPicker.setData(animalunit);
		
			/*初始化页面控件，全部清空*/
			var initForm = function(){ 
				//清空农户信息
				var table = document.body.querySelector('.mui-table-view');
				while(table.hasChildNodes()){
					table.removeChild(table.firstChild);
				}; 
				document.getElementById('showUnitPickerQ1').innerHTML="点击选择用量单位";
				document.getElementById('showUnitPickerQ1').value="";
				document.getElementById('showUnitYm1').innerHTML="点击选择数量单位";
				document.getElementById('showUnitYm1').value="";
				var inputList=document.querySelectorAll('input');
				for(var i=0;i<inputList.length;i++){
					inputList[i].value=""; 
				}
				
				document.getElementById('lqDate').innerHTML="请选择领取日期";
				document.getElementById('lqDate').value="";
				document.getElementById('mianyiDate').innerHTML="请选择免疫日期";
				document.getElementById('mianyiDate').value="";
				
				var attachContainer=document.getElementById('attachment').parentNode;
				var attachSpans=attachContainer.querySelectorAll('.attachment');
				for(var i=0;i<attachSpans.length;i++){
					attachContainer.removeChild(attachSpans[i]);
				}
				
				document.getElementById('addreplySaveBtn').disabled=false;
				document.querySelector('.delAttachment').style.display='';
			}; 
			
			/*增加新的农民*/	
			var addFarmer = function(farmer){
				var farmerForm=document.getElementById('farmerPart').querySelector('.mui-table-view');
				var li=document.createElement('li');
				li.className='mui-table-view-cell mui-collapse';
				li.innerHTML='<a class="mui-navigate-right" id="'+ farmer.id +'">'+farmer.name+'</a><div class="mui-collapse-content"><div class="mui-input-row"><label>农户电话</label>'+
				'<input id="farmerPhoneP1" type="text" readonly="true" value="'+ farmer.tel +'"/></div><div id="preventionreplyPart1" class="mui-content-padded" style="height:20px;”>'+
				'<h5 class="mui-pull-left">免疫动物</h5><button type="button" class="mui-btn mui-btn-link mui-pull-right addAnimal">添加</button></div><div id="animalAddPart5"></div></div>';
				farmerForm.appendChild(li);
				li.querySelector('.addAnimal').addEventListener('tap',function(){
					addAnimal(li.querySelector('#animalAddPart5'), '');
				});
				if(farmer.animals){
					for (var i=0; i<farmer.animals.length;i++) {
						addAnimal(li.querySelector('#animalAddPart5'),farmer.animals[i]);
					}
				}
			};
			
			/*增加新的动物*/
			var addAnimal = function(container, animal){
				var div=document.createElement('div');
				div.innerHTML='<div class="mui-input-group contentB"><div class="mui-input-row"><label>动物名称</label><input id="animalNameP1" type="text" class="animalName" placeholder="请输入动物名称">' +
					'</div><div class="mui-input-row"><label>数量</label><input id="animalCountP1" type="text" class="animalCount" placeholder="请输入动物数量"></div><div class="mui-input-row">'+
					'<button id="showUnitPickerP1" class="mui-btn mui-btn-block unitPicker" type="button">点击选择动物单位</button></div><span class="mui-icon mui-icon-close delIcon"></span></div>';
				container.insertBefore(div,container.firstChild);
				if(animal){
					div.querySelector('#animalNameP1').value=animal.name;
					div.querySelector('#animalCountP1').value=animal.count;
					div.querySelector('#showUnitPickerP1').value=animal.unit;
					div.querySelector('#showUnitPickerP1').innerText=app.getTextByValue(animalunit,animal.unit);
				}
				var unitPickerButton = div.querySelector('#showUnitPickerP1');
				unitPickerButton.addEventListener('tap', function(event) {
					userPicker.show(function(items) {
						unitPickerButton.innerText=items[0].text;
						unitPickerButton.value=items[0].value;
						//返回 false 可以阻止选择框的关闭
						//return false;
					});
				}, false);
				
				
				var delBtn=div.querySelector('.delIcon');
				delBtn.addEventListener('tap', function(){
					var btn = ["确定","取消"];
					mui.confirm('确认删除该条信息？','提示',btn,function(e){
						if(e.index==0){
							removeAnimal(container, div);
						}
					});
				});
			}; 
			
			/*删除动物信息*/
			var removeAnimal = function(container, div){
				div.querySelector('#showUnitPickerP1').removeEventListener('tap',function(){});
				div.querySelector('.delIcon').removeEventListener('tap',function(){});
				container.removeChild(div);
			};
			
			var addAttachment =function(attach){
				var attachContainer=document.getElementById('attachment').parentNode;
				var span=document.createElement('span');
				span.className='attachment';
				span.innerHTML='<i class="mui-icon mui-icon-paperclip"></i>'+attach.display;
				span.setAttribute('data-url',attach.url);
				attachContainer.insertBefore(span,attachContainer.firstChild);
				span.addEventListener('tap',function(){
					/*使用系统浏览器处理，感觉更好一些*/
					var currentUrl=plus.webview.currentWebview().getURL();
					plus.runtime.openURL(currentUrl.substr(0,currentUrl.lastIndexOf('/')+1)+app.filedownload_url+'?attaid='+this.getAttribute('data-url'));
					/*使用plus的下载工具处理*/
	//				var options = {method:"GET"};
	//				dtask = plus.downloader.createDownload( this.getAttribute('data-url'), options, function (task, status) {
	//					// 下载完成
	//					if ( status == 200 ) { 
	//						mui.toast( "下载完成！" );
	//					} else {
	//						mui.toast(errorCode.FAILED_DOWNLOAD);
	//					}  
	//				});
	//				dtask.addEventListener("statechanged", function(task,status){
	//				    	if(!dtask){return;}
	//				    	switch(task.state) {
	//				    		case 1: // 开始
	//				    			mui.toast( "开始下载..." );
	//				    		break;
	//				    		case 2: // 已连接到服务器
	//				    			mui.toast( "链接到服务器..." );
	//				    		break;
	//				    		case 3:	// 已接收到数据
	//				    			//mui.toast( "下载数据更新:" );
	//				    			//outLine( task.downloadedSize+"/"+task.totalSize );
	//				    		break;
	//				    		case 4:	// 下载完成
	//				    			//mui.toast( "下载完成！" );
	//				    		break;
	//				    	}
	//			    });
	//			    dtask.start();
				});
			};
			
			var onSuccess = function(data){
				//处理DOM对象，显示信息内容
				try{
					app.setValue('preventreplyNum',data.id);
					app.setValue('workersName1',workerName);
					app.setValue('vaccineinfoname1',data.vacname);
					app.setValue('guige1',data.spec);
					app.setValue('yongliang1',data.usecount);
					app.setValue('showUnitPickerQ1',data.useunit);
					app.setValue('yimiaoshuliang1',data.vaccount);
					app.setValue('showUnitYm1',data.vacunit);
					app.setValue('lqDate',data.recdate);
										
					farmerList = data.farmers || [];
					
					document.getElementById('showUnitPickerQ1').innerText=app.getTextByValue(useunit,data.useunit);
					document.getElementById('showUnitYm1').innerText=app.getTextByValue(vacunit,data.vacunit);
					document.getElementById('lqDate').innerText=data.recdate;
					
					for(var i=0; i< farmerList.length; i++){
						addFarmer(data.farmers[i]);
					}
					for(var i=0; i< data.attach.length; i++){
						addAttachment(data.attach[i]);
					}
					
					if(data.enddate){
						app.setValue('mianyiDate',data.enddate);
						document.getElementById('mianyiDate').innerText=data.enddate;
						document.getElementById('addreplySaveBtn').disabled=true;
						document.querySelector('.delAttachment').style.display='none';
						var addAnimal=document.querySelectorAll('.addAnimal');
						for(var i=0;i<addAnimal.length;i++)
							addAnimal[i].style.display='none';
						var delIcon=document.querySelectorAll('.delIcon');
						for(var i=0;i<delIcon.length;i++)
							delIcon[i].style.display='none';
					}
					
				}catch(e){
					console.log(e.message);
				    mui.toast(errorCode.BAD_DATA);
				}
				wd.close();
			};
			
			var onError = function(errcode){
				wd.close(); // 失败，先关闭等待的对话框  
				switch(errcode){
				    case 'FAILED_NETWORK':
				        mui.toast(errorCode.FAILED_NETWORK);
				        break;
				    case 'INVALID_FARMER':
				    		mui.toast(errorCode.INVALID_REPLYWORK);
				        break;
				    default:
				        mui.toast(errorCode.UNKNOW_ERROR);
			   };
			};
			
			var onRefreshSuccess = function(data){
				initForm();
				onSuccess(data);
			};
		
			var onRefreshError = function(errcode){
				onError(errcode);
			};
			
			
			var onSubmitSuccess = function(){
				wd.close(); 
				mui.toast('提交成功');
				mui.openWindow({id:'preventionreplysearch'});
			};
		
			var onSubmitError = function(errcode){
				onError(errcode);
			};
			
			var uploadAttachment = function(info){
				var newAttachmentList=mui('div.attachment');
				if(newAttachmentList.length==0){
					wd.setTitle('信息提交中，请等待...');
					app.webQuery(app.savereplyinfo_url,info,onSubmitSuccess,onSubmitError,1);
					return;
				}
				
				var currentUrl=plus.webview.currentWebview().getURL();
				var task=plus.uploader.createUpload(currentUrl.substr(0,currentUrl.lastIndexOf('/')+1) + app.replyupload_url,
					{method:"POST"},
					function(t, status){ //上传完成
						if(status==200){
							wd.setTitle('信息提交中，请等待...');
							app.webQuery(app.savereplyinfo_url,info,onSubmitSuccess,onSubmitError,1);
							mui.toast('上传成功');
						}else{
							mui.toast(errorCode.FAILED_UPLOAD + ":" + status);
							wd.setTitle("刷新信息中，请等待...",{back:"none"});
			      			var params={workId:workId};
			      			app.webQuery(app.getreplyinfo_url,params,onRefreshSuccess,onRefreshError,1);
						}
					}
				);
				
				task.addData("workId", workId);
				task.addData('fileCount',newAttachmentList.length.toString());
				
				mui('div.attachment').each(function(i,obj){
					task.addFile(obj.getAttribute('data-url'), {key:'attachment'+i});
				});
	
				task.start();
			};
			
			(function($, doc) {
				$.init({});
				$.plusReady(function() {
					//普通示例
//					var userPicker = new $.PopPicker();
//					userPicker.setData(animalunit);
//					var showUserPickerButton = doc.getElementById('showUnitPickerP1');
//					showUserPickerButton.addEventListener('tap', function(event) {
//						userPicker.show(function(items) {
//							showUserPickerButton.innerText = items[0].text;
//							showUserPickerButton.value = items[0].value;
//							//返回 false 可以阻止选择框的关闭
//							//return false;
//						});
//					}, false);
					
					var userPickerQ = new $.PopPicker();
					userPickerQ.setData(useunit);
					var showUserPickerButtonQ = doc.getElementById('showUnitPickerQ1');
					showUserPickerButtonQ.addEventListener('tap', function(event) {
						userPickerQ.show(function(items) {
							showUserPickerButtonQ.innerText = items[0].text;
							showUserPickerButtonQ.value = items[0].value;
							//返回 false 可以阻止选择框的关闭
							//return false;
						});
					}, false);
					
					var userPickerY = new $.PopPicker();
					userPickerY.setData(vacunit);
					var showUserPickerButtonY = doc.getElementById('showUnitYm1');
					showUserPickerButtonY.addEventListener('tap', function(event) {
						userPickerY.show(function(items) {
							showUserPickerButtonY.innerText = items[0].text;
							showUserPickerButtonY.value = items[0].value;
							//返回 false 可以阻止选择框的关闭
							//return false;
						});
					}, false);

					var result = new $.PopPicker(); 
					var btns = $('.btn');
					btns.each(function(i, btn) {
						btn.addEventListener('tap', function() {
							var optionsJson = this.getAttribute('data-options') || '{}';
							var options = JSON.parse(optionsJson);
							var id = this.getAttribute('id');
							var picker = new $.DtPicker(options);
							picker.show(function(rs) {
								doc.getElementById(id).innerText = rs.text;
								doc.getElementById(id).value = rs.value;
								picker.dispose();
							});
						}, false);
					});
					
					window.addEventListener('getReplyInfo',function(event){
			      		initForm();
			      		if(event.detail.id){
			      			workerName=event.detail.name;
			      			workId=event.detail.id;
			      			wd = plus.nativeUI.showWaiting("获取信息中，请等待...",{back:"none"});
			      			var params={workId:event.detail.id};
			      			app.webQuery(app.getreplyinfo_url,params,onSuccess,onError,1);
			      		}	
			      	});
			      	
			      	/*添加附件按钮响应，只允许添加图片*/
					document.getElementById('attachment').addEventListener('tap',function(){
						plus.gallery.pick( function(path){
					    		if(0!=path.indexOf("file://")){
								path="file://"+path;
							}
					    		var fileName=path.substring(path.lastIndexOf('/')+1);
					    		var attachContainer=document.getElementById('attachment').parentNode;
					    		var div=document.createElement('div');
					    		div.className='attachment';
					    		div.setAttribute('data-url',path);
					    		div.innerHTML='<span class="mui-icon mui-icon-trash delAttachment"></span></div> '+fileName;
					    		attachContainer.appendChild(div);
					    		var delBtn=div.querySelector('.delAttachment');
					    		delBtn.addEventListener('tap',function(){
					    			attachContainer.removeChild(div);
					    			delBtn.removeEventListener('tap',function(){});
					    		});
					    }, function ( e ) {
					    	
					    }, {filter:"image"} );
					});
					
					/*保存按钮响应*/
					document.getElementById('addreplySaveBtn').addEventListener('tap',function(){
						var vacName= app.getValue('vaccineinfoname1');
						var vacGuige= app.getValue('guige1');
						var vacYongliang= app.getValue('yongliang1');
						var vacYongliangUnit =app.getValue('showUnitPickerQ1');
						var vacShuliang =app.getValue('yimiaoshuliang1');
						var vacShuliangUnit =app.getValue('showUnitYm1');
						
						if(!vacName){
							mui.toast(errorCode.EMPTY_VACNAME);
							return;
						};
						
						if(!vacGuige){
							mui.toast(errorCode.EMPTY_VACSPEC);
							return;
						};
						
						if(!vacYongliang){
							mui.toast(errorCode.EMPTY_VACUSECOUNT);
							return;
						};
						
						if(!vacYongliangUnit){
							mui.toast(errorCode.EMPTY_VACUSEUNIT);
							return;
						};
						
						if(!vacShuliang){
							mui.toast(errorCode.EMPTY_VACCOUNT);
							return;
						};
						
						if(!vacShuliangUnit){
							mui.toast(errorCode.EMPTY_VACCOUNTUNIT);
							return;
						};
						
						if(farmerList.length==0){
							mui.toast(errorCode.EMPTY_FARMER);
							return;
						}
						
						var locatewd = plus.nativeUI.showWaiting("获取定位信息，请等待...",{back:"none"});
						plus.geolocation.getCurrentPosition(function(geoData){
							locatewd.close();
							document.getElementById('lat').value=geoData.coords.latitude;
							document.getElementById('lon').value=geoData.coords.longitude;
							//定位成功后才能提交
							var vacLqDate= app.getValue('lqDate');
							var vacMyDate= app.getValue('mianyiDate')||'';
							var farmers=[];
							for(var i=0;i<farmerList.length;i++){
								var animalList=[];
								var farmerInfo=farmerList[i];
								var farmerDom=document.getElementById(farmerInfo.id).parentNode;
								var animalNameList=farmerDom.querySelectorAll('.animalName');
								var animalCountList=farmerDom.querySelectorAll('.animalCount');
								var animalUnitList=farmerDom.querySelectorAll('.unitPicker');
								 
								for(var i=0;i<animalNameList.length;i++){
									if(animalNameList[i].value && animalCountList[i].value && animalUnitList[i].value)
										animalList.push({animalName:animalNameList[i].value,animalCount:animalCountList[i].value,animalUnit:animalUnitList[i].value});
								}
								
								farmers.push({id:farmerInfo.id,animals:animalList});
							};
							
							wd = plus.nativeUI.showWaiting("附件提交中，请等待...",{back:"none"});
			      			var params={workId:workId,lon:geoData.coords.longitude,lat:geoData.coords.latitude, vacName:vacName,spec:vacGuige,useCount:vacYongliang,useUnit:vacYongliangUnit,vacCount:vacShuliang,vacUnit:vacShuliangUnit, recDate:vacLqDate, replyDate:vacMyDate, farmers:JSON.stringify(farmers)};
			      			uploadAttachment(params);
						},function(err){
							locatewd.close();
							$.toast(errorCode.FAILED_LOCATED);
						});
					});					
				});
			})(mui, document);
		</script>
	</body>

</html>